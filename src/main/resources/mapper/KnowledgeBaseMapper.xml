<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="io.choerodon.kb.infra.mapper.KnowledgeBaseMapper">

    <resultMap id="knowledgeWithRecent" type="io.choerodon.kb.api.vo.KnowledgeBaseListVO">
        <id property="id" column="id"/>
        <id property="name" column="name"/>
        <id property="description" column="description"/>
        <id property="openRange" column="open_range"/>
        <id property="projectId" column="project_id"/>
        <collection property="workSpaceRecents" ofType="io.choerodon.kb.api.vo.WorkSpaceRecentVO">
            <id property="id" column="ID"/>
            <id property="route" column="route"/>
            <id property="title" column="title"/>
            <id property="lastUpdateDate" column="last_update_date"/>
            <id property="lastUpdatedBy" column="last_updated_by"/>
            <id property="projectId" column="project_id"/>
            <id property="organizationId" column="organization_id"/>
        </collection>
    </resultMap>

   <select id="queryKnowledgeBaseWithRecentUpate" resultMap="knowledgeWithRecent">
      select  * from kb_knowledge_base kb
       where
       1=1
       <if test="organizationId != null">
           AND kb.organization_id = #{organizationId}
       </if>
       <choose>
           <when test="projectId != null">
               AND kb.project_id = #{projectId}
               AND kb.open_range='range_private'
           </when>
           <otherwise>
               AND kb.project_id is null
           </otherwise>
       </choose>
       AND kb.is_delete = 0
   </select>


  <select id="listSystemTemplateBase" resultType="io.choerodon.kb.api.vo.KnowledgeBaseTreeVO">
      select distinct kbs.id,kbs.name,1 as topLeavl from kb_knowledge_base kbs
      left join kb_workspace ws on ws.base_id = kbs.id
      where
      kbs.project_id = 0
      and kbs.organization_id = 0
      <if test="searchVO != null">
              <if test="searchVO.contents != null and searchVO.contents.size > 0 ">
                  AND
                  <foreach collection="searchVO.contents" item="content" open="(" separator=" OR " close=")">
                      (ws.name LIKE CONCAT(CONCAT('%', #{content, jdbcType=VARCHAR}),'%'))
                      or
                      (kbs.name LIKE CONCAT(CONCAT('%', #{content, jdbcType=VARCHAR}),'%'))
                  </foreach>
              </if>
              <if test="searchVO.searchArgs != null">
                  <if test='searchVO.searchArgs.name != null'>
                      AND ((ws.name LIKE CONCAT(CONCAT('%', #{content, jdbcType=VARCHAR}),'%'))
                      or
                      (kbs.name LIKE CONCAT(CONCAT('%', #{content, jdbcType=VARCHAR}),'%')))
                  </if>
              </if>
          </if>
  </select>

    <select id="queryAllDetele" resultType="io.choerodon.kb.api.vo.RecycleVO">
        SELECT
        *
        FROM
        kb_knowledge_base kb
        WHERE
        1=1
        <if test="organizationId != null">
            AND kb.organization_id = #{organizationId}
        </if>
        <choose>
            <when test="projectId != null">
                AND kb.project_id = #{projectId}
            </when>
            <otherwise>
                AND kb.project_id is null
            </otherwise>
        </choose>
        AND kb.is_delete = 1
        <include refid="sqlparam"/>
        ORDER BY kb.last_update_date DESC
    </select>

    <sql id="sqlparam">
        <if test='searchDTO != null'>
            <if test="searchDTO.searchArgs != null">
                <if test='searchDTO.searchArgs.name != null and searchDTO.searchArgs.name.length > 0'>
                    AND
                    kb.name LIKE CONCAT(CONCAT('%', #{searchDTO.searchArgs.name, jdbcType=VARCHAR}),'%')
                </if>
            </if>
        </if>
    </sql>
</mapper>
